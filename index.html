#!/usr/bin/env python3
# index.html
from flask import Flask, request, redirect, url_for, render_template_string, abort
import os

app = Flask(__name__)

# In-memory storage
tasks = []
next_id = 1

# HTML template
PAGE = """
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Flask TODO List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --accent: #22c55e;
      --accent-hover: #16a34a;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --input: #1f2937;
      --border: #374151;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .container { max-width: 720px; margin: 40px auto; padding: 0 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 1.25rem; margin: 0; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    form.add { display: flex; gap: 10px; padding: 16px; border-bottom: 1px solid var(--border); background: linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.02)); }
    input[type="text"] { flex: 1; padding: 12px 14px; font-size: 1rem; background: var(--input); color: var(--text); border: 1px solid var(--border); border-radius: 8px; outline: none; }
    input[type="text"]::placeholder { color: #6b7280; }
    button { cursor: pointer; border: 0; border-radius: 8px; padding: 10px 14px; font-weight: 600; }
    .btn-add { background: var(--accent); color: #052e16; }
    .btn-add:hover { background: var(--accent-hover); }
    .btn-del { background: transparent; color: var(--danger); border: 1px solid var(--border); }
    .btn-del:hover { background: rgba(239, 68, 68, 0.08); border-color: var(--danger); }
    ul.tasks { list-style: none; margin: 0; padding: 0; }
    li.task { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    li.task:last-child { border-bottom: 0; }
    .task-text { flex: 1; word-break: break-word; }
    .empty { padding: 24px; text-align: center; color: var(--muted); }
    .id { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #93c5fd; font-size: 0.85rem; margin-right: 8px; }
    .actions { display: flex; gap: 8px; }
    .footer { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; color: var(--muted); font-size: 0.9rem; }
    .hint { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>TODO List</h1>
        <div class="muted">{{ tasks|length }} task{{ '' if tasks|length == 1 else 's' }}</div>
      </div>

      <form class="add" action="{{ url_for('add_task') }}" method="post" autocomplete="off">
        <input type="text" name="task" placeholder="What do you need to do?" required minlength="1" maxlength="200">
        <button type="submit" class="btn-add">Add</button>
      </form>

      {% if tasks %}
        <ul class="tasks">
          {% for t in tasks %}
            <li class="task">
              <div class="task-text">
                <span class="id">#{{ t.id }}</span>
                {{ t.text }}
              </div>
              <div class="actions">
                <form action="{{ url_for('delete_task', id=t.id) }}" method="post" onsubmit="return confirm('Delete task #{{ t.id }}?');">
                  <button type="submit" class="btn-del" title="Delete">Delete</button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty">No tasks yet. Add your first task above.</div>
      {% endif %}

      <div class="footer">
        <div>Backend: Flask (in-memory)</div>
        <div class="hint">POST /add, POST /delete/&lt;id&gt;, GET /</div>
      </div>
    </div>
  </div>
</body>
</html>
"""

# Helpers
def _find_task_index(task_id: int):
    for i, t in enumerate(tasks):
        if t["id"] == task_id:
            return i
    return None

# Routes
@app.get("/")
def index():
    # Represent tasks as simple objects for dot-notation in Jinja
    class Obj(dict):
        __getattr__ = dict.get
    view_tasks = [Obj(id=t["id"], text=t["text"]) for t in tasks]
    return render_template_string(PAGE, tasks=view_tasks)

@app.post("/add")
def add_task():
    global next_id
    text = (request.form.get("task") or "").strip()
    if text:
        tasks.append({"id": next_id, "text": text})
        next_id += 1
    return redirect(url_for("index"))

@app.route("/delete/<int:id>", methods=["POST"])
def delete_task(id: int):
    idx = _find_task_index(id)
    if idx is None:
        # Silently ignore missing ids to keep UX smooth, or use 404:
        # abort(404)
        return redirect(url_for("index"))
    tasks.pop(idx)
    return redirect(url_for("index"))

if __name__ == "__main__":
    app.run(debug=True, host=os.getenv("HOST", "0.0.0.0"), port=int(os.getenv("PORT", "5000")))